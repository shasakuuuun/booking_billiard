<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Genzyeeeh Billiard FINAL</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,Arial;background:#f7fafc;color:#0f172a}
    .wrap{max-width:1200px;margin:20px auto;padding:16px}
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:240px;background:#fff;
      border-right:1px solid #e6eef8;padding:20px;overflow:auto}
    .main{margin-left:260px;padding:20px}
    .user{display:flex;gap:12px;align-items:center;margin-bottom:18px;
      border-bottom:1px solid #eef2f7;padding-bottom:12px}
    .avatar{width:44px;height:44px;background:#2563eb;color:#fff;border-radius:8px;
      display:flex;justify-content:center;align-items:center;font-weight:700}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
    .nav a{padding:10px;border-radius:8px;cursor:pointer;text-decoration:none;
      color:#475569}
    .nav a.active,.nav a:hover{background:#f1f5f9;color:#1e3a8a}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .btn{padding:10px 14px;border:0;border-radius:8px;cursor:pointer;font-weight:600}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-success{background:#059669;color:#fff}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-secondary{background:#f1f5f9;color:#475569}
    .card{background:#fff;border:1px solid #e6eef8;border-radius:10px;padding:16px;margin-bottom:16px}
    .booking{padding:12px;border:1px solid #eef2f7;border-radius:8px;background:#fff;margin-bottom:10px}
    #statusMeja{display:flex;gap:12px;flex-wrap:wrap}
    .meja-card{border:1px solid #eef2f7;border-radius:8px;padding:12px;width:calc(50% - 10px);background:#fff}
    .toast{position:fixed;right:20px;top:20px;padding:10px 14px;border-radius:8px;
      min-width:200px;color:#fff;font-weight:600;z-index:9999;box-shadow:0 6px 18px rgba(0,0,0,.15)}
    .toast.success{background:#059669}.toast.error{background:#ef4444}.toast.info{background:#0284c7}
    @media(max-width:900px){.sidebar{position:relative;width:100%}.main{margin-left:0}.meja-card{width:100%}}
  </style>
</head>
<body>

<div class="sidebar">
  <div class="user">
    <div class="avatar">A</div>
    <div><b>Admin</b><br><small>admin@billiard.co</small></div>
  </div>
  <nav class="nav">
    <a class="nav-item active" data-target="dashboard">ðŸ“Š Dashboard</a>
    <a class="nav-item" data-target="lamp">ðŸ’¡ Lamp Control</a>
    <a class="nav-item" data-target="bookings">ðŸ“‹ Bookings</a>
  </nav>
</div>

<div class="main wrap">
  <div class="header">
    <h2>Admin Dashboard</h2>
    <button class="btn btn-secondary" id="logoutBtn">Logout</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="section">
    <div class="card">
      <h3>Semua Booking Hari Ini</h3>
      <div id="adminBookingList">Loading...</div>
    </div>
  </div>

  <!-- LAMP CONTROL -->
  <div id="lamp" class="section" style="display:none;">
    <div class="card">
      <h3>Kontrol Manual</h3>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
        <button class="btn btn-success" onclick="manual(1,'ON')">Meja 1 ON</button>
        <button class="btn btn-danger" onclick="manual(1,'OFF')">Meja 1 OFF</button>

        <button class="btn btn-success" onclick="manual(2,'ON')">Meja 2 ON</button>
        <button class="btn btn-danger" onclick="manual(2,'OFF')">Meja 2 OFF</button>

        <button class="btn btn-primary" onclick="globalControl('ON')">Semua ON</button>
        <button class="btn btn-primary" onclick="globalControl('OFF')">Semua OFF</button>

        <button class="btn btn-secondary" onclick="resetMeja()">ðŸ”„ Reset Meja</button>
      </div>
    </div>

    <div class="card">
      <h3>Status Meja</h3>
      <div id="statusMeja">Memuat...</div>
    </div>
  </div>

  <!-- BOOKINGS -->
  <div id="bookings" class="section" style="display:none;">
    <div class="card">
      <h3>Detail Booking Hari Ini</h3>
      <div id="detailedBookings">Loading...</div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toastRoot"></div>

<script>
const API = "";
let adminToken = localStorage.getItem("adminToken");

// ---------------- TOAST ----------------
function toast(msg,type="info",time=2000){
  const box=document.createElement("div");
  box.className="toast "+type;
  box.textContent=msg;
  document.getElementById("toastRoot").appendChild(box);
  setTimeout(()=>{box.remove()},time);
}

// ---------------- NAV ----------------
document.querySelectorAll(".nav-item").forEach(n=>{
  n.onclick=()=>{
    document.querySelectorAll(".nav-item").forEach(a=>a.classList.remove("active"));
    n.classList.add("active");
    document.querySelectorAll(".section").forEach(s=>s.style.display="none");
    document.getElementById(n.dataset.target).style.display="block";
  };
});

// ---------------- LOGOUT ----------------
document.getElementById("logoutBtn").onclick=()=>{
  localStorage.removeItem("adminToken");
  toast("Logout berhasil","success");
  setTimeout(()=>location.href="login.html",800);
};

// ---------------- LOAD ALL ----------------
async function loadAll(){
  loadBookings();
  loadDetailedBookings();
  loadStatusMeja();
}
setInterval(loadAll,10000);
loadAll();

// ---------------- BOOKINGS ----------------
async function loadBookings(){
  try{
    const r=await fetch(API+"/api/bookings");
    const data=await r.json();
    const box=document.getElementById("adminBookingList");
    if(!data.length){box.innerHTML="Tidak ada booking";return}
    box.innerHTML=data.map(b=>`
      <div class="booking">
        <b>${b.nama}</b> â€” Meja ${b.meja_id}<br>
        ${b.jam_mulai} - ${b.jam_selesai} (${b.durasi} jam)
      </div>`).join("");
  }catch{toast("Gagal load bookings","error")}
}

async function loadDetailedBookings(){
  const r=await fetch(API+"/api/bookings");
  const data=await r.json();
  const box=document.getElementById("detailedBookings");
  if(!data.length){box.innerHTML="Tidak ada booking";return}
  box.innerHTML=data.map(b=>`
    <div class="booking">
      <b>${b.nama}</b> â€” Meja ${b.meja_id}<br>
      ${b.jam_mulai} - ${b.jam_selesai}
    </div>`).join("");
}

// ---------------- STATUS MEJA ----------------
async function loadStatusMeja(){
  try{
    const r=await fetch(API+"/api/status-meja");
    const data=await r.json();
    const box=document.getElementById("statusMeja");
    box.innerHTML="";
    data.forEach(m=>{
      box.innerHTML+=`
        <div class="meja-card">
          <b>${m.nama_meja}</b><br>
          Lampu: ${m.status_lampu? "ðŸŸ¢ ON":"âš« OFF"}<br>
          Status: ${m.status_booking}
        </div>`;
    });
  }catch{
    toast("Gagal load status meja","error");
  }
}

// ---------------- MANUAL ----------------
async function manual(id,act){
  const r=await fetch(API+"/api/manual-control",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({meja_id:id,action:act})
  });
  const d=await r.json();
  if(r.ok) toast(d.message,"success");
  else toast("Gagal kontrol","error");
  loadStatusMeja();
}

// ---------------- GLOBAL ----------------
async function globalControl(act){
  if(!adminToken){return toast("Session expired","error")}
  const r=await fetch(API+"/api/lampu/control",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":adminToken
    },
    body:JSON.stringify({action:act})
  });
  const d=await r.json();
  if(r.ok) toast(d.message,"success");
  else toast("Gagal global control","error");
  loadStatusMeja();
}

// ---------------- RESET MEJA (FINAL FIX) ----------------
async function resetMeja(){
  const r=await fetch(API+"/api/reset-meja",{method:"POST"});
  const d=await r.json();
  if(r.ok) toast("RESET BERHASIL!","success");
  else toast("Gagal reset meja","error");
  loadAll();
}
</script>

</body>
</html>
